@page "/viewplan"
@page "/viewplan/{PlanId:int}"
@page "/viewplan/{PlanId:int}/{Detail?}"

@rendermode InteractiveServer
@using Therapeasy.Enums
@using Therapeasy.Model
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text
@using QRCoder
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
<AuthorizeView Roles="Admin,Therapist,Patient" Context="authContext">
    <h5><a class="link" href="/plan/@plan.Id/detailed"><strong>@plan.Name</strong></a></h5>
    <p><strong>added on @plan.GetFormattedDateAdded() by @plan.CreatedByUser</strong></p>
    <p><strong>for @plan.BodyRegion.GetDisplayName()</strong></p>
    <img src="@(qrImgSrc)" style="height:200px;width:200px" />
    @if (Detail == "detailed")
    {
        @foreach (PlanExerciseLink link in planExerciseLinks.Where(l => l.PlanId == plan.Id))
        {
        <ThisExercise ExerciseId="link.ExerciseId" Detail=@Detail />
        <hr />
        }
    }
</AuthorizeView>

@code {
    [Parameter]
    public int PlanId { get; set; } = 0;
    [Parameter]
    public string Detail { get; set; } = "nodetail";
    Plan plan = new Plan();
    Exercise exerciseToAdd = new();

    List<PlanExerciseLink> planExerciseLinks = new();
    private int exerciseDlt = -1;
    private string qrImgSrc = "";

    protected override async Task OnInitializedAsync()
    {
      await LoadPlan();
      qrImgSrc = GetQR();
    }
    private async Task LoadPlan()
    {
        if (PlanId > 0)
        {
          var responsePlan = await HttpClient.GetFromJsonAsync<Plan>(NavigationManager.BaseUri + "plandb/get/planfromid/" + PlanId);
          if (responsePlan != null)
          {
            plan = responsePlan;
            var responseLinks = await HttpClient.GetFromJsonAsync<List<PlanExerciseLink>>(NavigationManager.BaseUri + "plandb/get/planexerciselinksforplan/" + plan.Id);
            if (responseLinks != null) planExerciseLinks.AddRange(responseLinks);
          }
        }
    }
    
    private string GetQR()
    {
      using (QRCodeGenerator qrGenerator = new QRCodeGenerator())
      using (QRCodeData qrCodeData = qrGenerator.CreateQrCode(NavigationManager.BaseUri + "plan/" + plan.Id + "/detailed", QRCodeGenerator.ECCLevel.Q))
      using (PngByteQRCode qrCode = new PngByteQRCode(qrCodeData))
      {
          byte[] qrCodeImage = qrCode.GetGraphic(20);
          return String.Format("data:image/gif;base64,{0}", Convert.ToBase64String(qrCodeImage));
      }
    }
}